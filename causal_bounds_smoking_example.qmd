---
title: "Causal Bounds for Observational Data"
author: "Uriah Finkel"
format: revealjs
---

## Causal Question {.smaller}

```{r}
#| echo: false

library(reactable)
library(dplyr)
```

::::: columns
::: {.column width="50%"}
What are the bounds on the Individual Treatment Effect (ITE) of smoking üö¨ vs. not smoking üö≠ on COPD ü´Å, given only one observed background variable ‚Äî whether the parents smoke?

Under the **Monotonicity Assumption**, we assume that having smoking parents üò§ can only increase a child‚Äôs risk of developing COPD ü´Å through passive exposure.
:::

::: {.column width="50%"}
![](smoking_parents.png)
:::
:::::

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}
countefactual_data <- tibble::tribble(
   ~"X", ~"A", ~"Y_a0", ~"Y_a1",
   "0", "1", "0", "1",
   "0", "1", "0", "0",
   "0", "0", "1", "1",
   "0", "0", "0", "1",
   "0", "0", "0", "0",
   "0", "0", "0", "0",
   "1", "1", "1", "1",
   "1", "1", "1", "1",
   "1", "1", "1", "1",
   "1", "1", "1", "1",
   "1", "1", "1", "1",
   "1", "1", "0", "1",
   "1", "1", "0", "0",
   "1", "1", "0", "0",
   "1", "0", "1", "1",
   "1", "0", "0", "1"
  ) |> 
  mutate(
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    ),
    ITE = as.numeric(Y_a1) - as.numeric(Y_a0)
  ) |> 
  arrange(
    A, observed_y, X
  )
```

```{r}
countefactual_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
    observed_y = colDef(
      show = FALSE
    ),
    ITE = colDef(
      show = FALSE
    ),
    Y_a0 = colDef(
      name = "Y<sup>0",
      html = TRUE
    ),
    Y_a1 = colDef(
      name = "Y<sup>1",
      html = TRUE
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))


countefactual_data_reactable_raw
```
:::

::: {.column width="65%"}
#### üòá God-Given Counterfactual Data

-   By God-Given knowledge we have access to the true counterfactual outcomes for each individual for smoking üö¨ and for not smoking üö≠
:::
:::::

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}


countefactual_data_reactable_raw_with_ITE <- countefactual_data |> 
  reactable(
    theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
    observed_y = colDef(
      show = FALSE
    ),
    Y_a0 = colDef(
      name = "Y<sup>0",
      html = TRUE
    ),
    Y_a1 = colDef(
      name = "Y<sup>1",
      html = TRUE
    ),
    ITE = colDef(
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

countefactual_data_reactable_raw_with_ITE
```
:::

::: {.column width="65%"}
#### üòá God-Given Counterfactual Data

-   By God-Given knowledge we have access to the true counterfactual outcomes for each individual for smoking üö¨ and for not smoking üö≠

-   This gives us 4 Compliers: people who get COPD only if they smoke, and avoid it otherwise. It also goes by the name **PNS**: **P**robability of **N**ecessity and **S**ufficiensy:

$\text{PNS} = \frac{4}{16} = 0.25$
:::
:::::

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}


real_data_reactable_raw <- countefactual_data |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
    observed_y = colDef(
      name = "Y",
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    ),
    A = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#F2F3AE")
      } 
    ),
    Y_a0 = colDef(
      show = FALSE
    ),
    Y_a1 = colDef(
      show = FALSE
    ),
    ITE = colDef(
      show = FALSE
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw
```
:::

::: {.column width="65%"}
#### üòà Observed Data

-   By God-Given knowledge we have access to the true counterfactual outcomes for each individual for smoking üö¨ and for not smoking üö≠

-   This gives us 4 Compliers: people who get COPD only if they smoke, and avoid it otherwise. It also goes by the name **PNS**: **P**robability of **N**ecessity and **S**ufficiensy:

$\text{PNS} = \frac{4}{16} = 0.25$

-   In real life we can analyse only the observed outcomes, so we can never know the true Individual Treatment Effect. But fortunately, we can use Causal Bounds.
:::
:::::

# Population Level Bounds

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}


real_data_reactable_raw <- countefactual_data |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
    observed_y = colDef(
      name = "Y",
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    ),
    A = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#F2F3AE")
      } 
    ),
    X = colDef(show = FALSE),
    Y_a0 = colDef(
      show = FALSE
    ),
    Y_a1 = colDef(
      show = FALSE
    ),
    ITE = colDef(
      show = FALSE
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw
```
:::

::: {.column width="65%"}
#### Bounds PNS

$$ 0 \le \text{PNS} \le $$

-   In order to bound PNS we need to count the possible proportion of Compliers:
:::
:::::

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}


real_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle  = list(backgroundColor = "#F5F2EB"),
      headerStyle = list(backgroundColor = "#F5F2EB"),
      cellStyle   = list(backgroundColor = "#F5F2EB")
    ),
    sortable = FALSE,
    defaultPageSize = 19,
    columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          # bold if A == "0" and Y == "1"
          A_value <- countefactual_data$A[index]
          if (A_value == "0" && value == "0") {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data$observed_y[index]
          if (value == "0" && Y_value == "0") {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      X = colDef(show = FALSE),
      Y_a0 = colDef(show = FALSE),
      Y_a1 = colDef(show = FALSE),
      ITE  = colDef(show = FALSE)
    ),
    defaultColDef = colDef(maxWidth = 50),
    style = list(fontSize = "1rem")
  )

real_data_reactable_raw
```
:::

::: {.column width="65%"}
#### Bounds PNS

$$ 0 \le \text{PNS} \le \frac{4}{16} + $$

-   In order to bound PNS we need to count the possible proportion of Compliers:

-   The total number of observed non-events without treatment, they might be Compliers or Never-Takers.
:::
:::::

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}


real_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle  = list(backgroundColor = "#F5F2EB"),
      headerStyle = list(backgroundColor = "#F5F2EB"),
      cellStyle   = list(backgroundColor = "#F5F2EB")
    ),
    sortable = FALSE,
    defaultPageSize = 19,
    columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          A_value <- countefactual_data$A[index]
          if (A_value == "1" && value == "1") {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data$observed_y[index]
          if (value == "1" && Y_value == "1") {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      X = colDef(show = FALSE),
      Y_a0 = colDef(show = FALSE),
      Y_a1 = colDef(show = FALSE),
      ITE  = colDef(show = FALSE)
    ),
    defaultColDef = colDef(maxWidth = 50),
    style = list(fontSize = "1rem")
  )

real_data_reactable_raw
```
:::

::: {.column width="65%"}
#### Bounds PNS

$$ 0 \le \text{PNS} \le \frac{4}{16} + \frac{7}{16} $$

-   In order to bound PNS we need to count the possible proportion of Compliers:

-   The total number of observed non-events without treatment, they might be Compliers or Never-Takers.

-   The total number of observed events with treatment, they might be Compliers or Always-Takers.
:::
:::::

##  {.smaller}

::::: columns
::: {.column width="35%"}
```{r}


real_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle  = list(backgroundColor = "#F5F2EB"),
      headerStyle = list(backgroundColor = "#F5F2EB"),
      cellStyle   = list(backgroundColor = "#F5F2EB")
    ),
    sortable = FALSE,
    defaultPageSize = 19,
    columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          A_value <- countefactual_data$A[index]
          if ((A_value == "1" && value == "1") | (A_value == "0" && value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data$observed_y[index]
          if ((value == "1" && Y_value == "1") | (value == "0" && Y_value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      X = colDef(show = FALSE),
      Y_a0 = colDef(show = FALSE),
      Y_a1 = colDef(show = FALSE),
      ITE  = colDef(show = FALSE)
    ),
    defaultColDef = colDef(maxWidth = 50),
    style = list(fontSize = "1rem")
  )

real_data_reactable_raw
```
:::

::: {.column width="65%"}
#### Bounds PNS

$$ 0 \le \text{PNS} \le \frac{11}{16} $$ Now we know the bounds of the PNS.

It resonates with our true "God-Given" PNS:

$$ 0 \le \text{PNS} = \frac{4}{16} \le \frac{11}{16} $$
:::
:::::

# Bounds for Sub-Populations

##  {.smaller}

::: columns

::: {.column width="35%"}

```{r}

real_data_reactable_raw <- countefactual_data |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
    observed_y = colDef(
      name = "Y",
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    ),
    A = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#F2F3AE")
      } 
    ),
    X = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#65DEF1")
      } 
    ),
    Y_a0 = colDef(
      show = FALSE
    ),
    Y_a1 = colDef(
      show = FALSE
    ),
    ITE = colDef(
      show = FALSE
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw

```

:::

::: {.column width="65%"}

#### Bounds PNS for Subpopulations

$$ 0 \le \text{PNS | Smoking-Parents} \le  \text{?}$$
$$ 0 \le \text{PNS | Non-Smoking-Parents} \le  \text{?}$$

In order to bound PNS we need to count the possible proportion of Compliers **within** each Sub-population.




:::

:::


##  {.smaller}

::: columns

::: {.column width="50%"}

#### Non-Smoking-Parents

$$\small{0 \le \text{PNS | Non-Smoking-Parents} \le  \frac{4}{6}}$$

```{r}

countefactual_data_non_smoking_parents <- countefactual_data |> 
  filter(X == "0")

real_data_reactable_raw_non_smoking_parents <- countefactual_data_non_smoking_parents |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          A_value <- countefactual_data_non_smoking_parents$A[index]
          if ((A_value == "1" && value == "1") | (A_value == "0" && value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data_non_smoking_parents$observed_y[index]
          if ((value == "1" && Y_value == "1") | (value == "0" && Y_value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
    X = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#65DEF1")
      } 
    ),
    Y_a0 = colDef(
      show = FALSE
    ),
    Y_a1 = colDef(
      show = FALSE
    ),
    ITE = colDef(
      show = FALSE
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw_non_smoking_parents

```

:::

::: {.column width="50%"}

#### Smoking Parents

$$\small{0 \le \text{PNS | Smoking-Parents} \le  \frac{7}{10}}$$

```{r}

countefactual_data_smoking_parents <- countefactual_data |> 
  filter(X == "1")

real_data_reactable_raw_smoking_parents <- countefactual_data_smoking_parents |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          A_value <- countefactual_data_smoking_parents$A[index]
          if ((A_value == "1" && value == "1") | (A_value == "0" && value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data_smoking_parents$observed_y[index]
          if ((value == "1" && Y_value == "1") | (value == "0" && Y_value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
    X = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#65DEF1")
      } 
    ),
    Y_a0 = colDef(
      show = FALSE
    ),
    Y_a1 = colDef(
      show = FALSE
    ),
    ITE = colDef(
      show = FALSE
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw_smoking_parents

```


:::

:::

##  {.smaller}

::: columns

::: {.column width="50%"}

#### Non-Smoking-Parents

$$\small{0 \le \text{PNS | Non-Smoking-Parents = } \frac{2}{6}  \le  \frac{4}{6}}$$

```{r}

countefactual_data_non_smoking_parents <- countefactual_data |> 
  filter(X == "0")

real_data_reactable_raw_non_smoking_parents <- countefactual_data_non_smoking_parents |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          A_value <- countefactual_data_non_smoking_parents$A[index]
          if ((A_value == "1" && value == "1") | (A_value == "0" && value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data_non_smoking_parents$observed_y[index]
          if ((value == "1" && Y_value == "1") | (value == "0" && Y_value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
    X = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#65DEF1")
      } 
    ),
    Y_a0 = colDef(
      name = "Y<sup>0",
      html = TRUE
    ),
    Y_a1 = colDef(
      name = "Y<sup>1",
      html = TRUE
    ),
    ITE = colDef(
      style = function(value) {
      if(value == "1")
      list(background = "pink", fontWeight = "bold")
    }
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw_non_smoking_parents

```

:::

::: {.column width="50%"}

#### Smoking Parents

$$\small{0 \le \text{PNS | Smoking-Parents = } \frac{2}{10} \le  \frac{7}{10}}$$

```{r}

countefactual_data_smoking_parents <- countefactual_data |> 
  filter(X == "1")

real_data_reactable_raw_smoking_parents <- countefactual_data_smoking_parents |> 
  reactable(
        theme = reactableTheme(backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
      observed_y = colDef(
        name = "Y",
        style = function(value, index, name) {
          # base style: pink if Y == "1"
          style <- if (value == "1") {
            list(background = "pink")
          } else {
            list()
          }
          
          A_value <- countefactual_data_smoking_parents$A[index]
          if ((A_value == "1" && value == "1") | (A_value == "0" && value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
      A = colDef(
        style = function(value, index, name) {
          # base style: yellow if A == "1"
          style <- if (value == "1") {
            list(background = "#F2F3AE")
          } else {
            list()
          }
          
          Y_value <- countefactual_data_smoking_parents$observed_y[index]
          if ((value == "1" && Y_value == "1") | (value == "0" && Y_value == "0")) {
            style$fontWeight <- "bold"
          }
          
          style
        }
      ),
    X = colDef(
      style = function(value) {
      if (value == "1")
      list(background = "#65DEF1")
      } 
    ),
    Y_a0 = colDef(
      name = "Y<sup>0",
      html = TRUE
    ),
    Y_a1 = colDef(
      name = "Y<sup>1",
      html = TRUE
    ),
    ITE = colDef(
      style = function(value) {
      if(value == "1")
      list(background = "pink", fontWeight = "bold")
    }
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))

real_data_reactable_raw_smoking_parents

```


:::

:::

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_no_outcome <- countefactual_data |>  -->

<!--   reactable( -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   columns = list( -->

<!--     observed_y = colDef( -->

<!--       name = "Y", -->

<!--       show = FALSE -->

<!--     ), -->

<!--     Y_a0 = colDef( -->

<!--       show = FALSE -->

<!--     ), -->

<!--     Y_a1 = colDef( -->

<!--       show = FALSE -->

<!--     ), -->

<!--     ITE = colDef( -->

<!--       show = FALSE -->

<!--     ) -->

<!--   ), -->

<!--   defaultColDef = colDef(maxWidth = 40), -->

<!--   style = list(fontSize = "1rem")) -->

<!-- real_data_no_outcome -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### IPW ‚öñÔ∏è -->

<!-- -   IPW is a method for manipulating the sample while creating pseudo-population. Therefore, we don't need the outcome for the first step. -->

<!-- -   But we do need to estimate the probability of having a treatment for each individual given the confounders. -->

<!-- $p(A|X)$ -->

<!-- On the non-parametric case it's just the proportions of the treated patients from the subpopulation $X=x$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_no_outcome_a0_x0 <- countefactual_data |>  -->

<!--   select(X, A) |>  -->

<!--   reactable( -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 40), -->

<!--   rowStyle = function(index) { -->

<!--     if ( -->

<!--       (countefactual_data[index, "X"] == "0") && -->

<!--       (countefactual_data[index, "A"] == "0")) list(background = "rgba(0, 0, 0, 0.15)") else if ( -->

<!--         (countefactual_data[index, "X"] == "0") && -->

<!--       (countefactual_data[index, "A"] == "1") -->

<!--       ) list(background = "rgba(0, 0, 0, 0.05)") -->

<!--   }, -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE) -->

<!-- real_data_no_outcome_a0_x0 -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### IPW ‚öñÔ∏è -->

<!-- -   IPW is a method for manipulating the sample while creating pseudo-population. Therefore, we don't need the outcome for the first step. -->

<!-- -   But we do need to estimate the probability of having a treatment for each individual given the confounders. -->

<!-- $p(A = 0|X = 0) = \frac{4}{6}$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_no_outcome_a0_x0 <- countefactual_data |>  -->

<!--   select(X, A) |>  -->

<!--   reactable( -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 40), -->

<!--   rowStyle = function(index) { -->

<!--     if ( -->

<!--       (countefactual_data[index, "X"] == "0") && -->

<!--       (countefactual_data[index, "A"] == "1")) list(background = "rgba(0, 0, 0, 0.15)") else if ( -->

<!--         (countefactual_data[index, "X"] == "0") && -->

<!--       (countefactual_data[index, "A"] == "0") -->

<!--       ) list(background = "rgba(0, 0, 0, 0.05)") -->

<!--   }, -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE) -->

<!-- real_data_no_outcome_a0_x0 -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### IPW ‚öñÔ∏è -->

<!-- -   IPW is a method for manipulating the sample while creating pseudo-population. Therefore, we don't need the outcome for the first step. -->

<!-- -   But we do need to estimate the probability of having a treatment for each individual given the confounders. -->

<!-- $p(A = 0|X = 0) = \frac{4}{6}$ -->

<!-- $p(A = 1|X = 0) = \frac{2}{6}$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_no_outcome_a0_x0 <- countefactual_data |>  -->

<!--   select(X, A) |>  -->

<!--   reactable( -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 40), -->

<!--   rowStyle = function(index) { -->

<!--     if ( -->

<!--       (countefactual_data[index, "X"] == "1") && -->

<!--       (countefactual_data[index, "A"] == "0")) list(background = "rgba(0, 0, 0, 0.15)") else if ( -->

<!--         (countefactual_data[index, "X"] == "1") && -->

<!--       (countefactual_data[index, "A"] == "1") -->

<!--       ) list(background = "rgba(0, 0, 0, 0.05)") -->

<!--   }, -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE) -->

<!-- real_data_no_outcome_a0_x0 -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### IPW ‚öñÔ∏è -->

<!-- -   IPW is a method for manipulating the sample while creating pseudo-population. Therefore, we don't need the outcome for the first step. -->

<!-- -   But we do need to estimate the probability of having a treatment for each individual given the confounders. -->

<!-- $p(A = 0|X = 0) = \frac{4}{6}$ -->

<!-- $p(A = 1|X = 0) = \frac{2}{6}$ -->

<!-- $p(A = 0|X = 1) = \frac{2}{10}$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_no_outcome_a0_x0 <- countefactual_data |>  -->

<!--   select(X, A) |>  -->

<!--   reactable( -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 40), -->

<!--   rowStyle = function(index) { -->

<!--     if ( -->

<!--       (countefactual_data[index, "X"] == "1") && -->

<!--       (countefactual_data[index, "A"] == "1")) list(background = "rgba(0, 0, 0, 0.15)") else if ( -->

<!--         (countefactual_data[index, "X"] == "1") && -->

<!--       (countefactual_data[index, "A"] == "0") -->

<!--       ) list(background = "rgba(0, 0, 0, 0.05)") -->

<!--   }, -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE) -->

<!-- real_data_no_outcome_a0_x0 -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### IPW ‚öñÔ∏è -->

<!-- -   IPW is a method for manipulating the sample while creating pseudo-population. Therefore, we don't need the outcome for the first step. -->

<!-- -   But we do need to estimate the probability of having a treatment for each individual given the confounders. -->

<!-- $p(A = 0|X = 0) = \frac{4}{6}$ -->

<!-- $p(A = 1|X = 0) = \frac{2}{6}$ -->

<!-- $p(A = 0|X = 1) = \frac{2}{10}$ -->

<!-- $p(A = 1|X = 1) = \frac{8}{10}$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ## Weights for Non-Smoking Parents üòê {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="50%"} -->

<!-- ```{r} -->

<!-- data.frame( -->

<!--   Population = c( -->

<!--     paste( -->

<!--     rep( -->

<!--     "üö≠", 4 -->

<!--   ), collapse = ""), -->

<!--   paste( -->

<!--     rep( -->

<!--     "üö¨", 2 -->

<!--   ), collapse = "") -->

<!--     ), -->

<!--   Propensity = c( -->

<!--     "4 / 6", -->

<!--     "2 / 6" -->

<!--   ), -->

<!--   IPW = c( -->

<!--     "6 / 4", -->

<!--     "6 / 2" -->

<!--   ) -->

<!--   ) |> -->

<!--   reactable( -->

<!--     columns = list( -->

<!--       Population = colDef( -->

<!--         maxWidth = 160 -->

<!--       ), -->

<!--       Propensity = colDef( -->

<!--         name = "P(A|L)", -->

<!--         maxWidth = 100 -->

<!--       ), -->

<!--       IPW = colDef( -->

<!--         name = "W<sup>A", -->

<!--         maxWidth = 100, -->

<!--         html = TRUE -->

<!--       ) -->

<!--       ), -->

<!--   columnGroups = list( -->

<!--     colGroup(name = "Original Sample", columns = c("Population", "Propensity")) -->

<!--   ) -->

<!--   ) -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="50%"} -->

<!-- ![](imbalanced_non_smoking_parents.svg) -->

<!-- ::: -->

<!-- ::: -->

<!-- ## Weights for Non-Smoking Parents üòê {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="50%"} -->

<!-- ```{r} -->

<!-- data.frame( -->

<!--   Population = c( -->

<!--     paste( -->

<!--     rep( -->

<!--     "üö≠", 6 -->

<!--   ), collapse = ""), -->

<!--   paste( -->

<!--     rep( -->

<!--     "üö¨", 6 -->

<!--   ), collapse = "") -->

<!--     ), -->

<!--   Propensity = c( -->

<!--     "6 / 12", -->

<!--     "6 / 12" -->

<!--   ) -->

<!--   ) |> -->

<!--   reactable( -->

<!--     columns = list( -->

<!--       Population = colDef( -->

<!--         maxWidth = 160 -->

<!--       ), -->

<!--       Propensity = colDef( -->

<!--         name = "P(A|L)", -->

<!--         maxWidth = 100 -->

<!--       ) -->

<!--       ), -->

<!--   columnGroups = list( -->

<!--     colGroup(name = "Weighted Sample", columns = c("Population", "Propensity")) -->

<!--   ) -->

<!--   ) -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="50%"} -->

<!-- ![](balanced_non_smoking_parents.svg) -->

<!-- ::: -->

<!-- ::: -->

<!-- ## Weights for Smoking Parents üò§ {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="50%"} -->

<!-- ```{r} -->

<!-- data.frame( -->

<!--   Population = c( -->

<!--     paste( -->

<!--     rep( -->

<!--     "üö≠", 2 -->

<!--   ), collapse = ""), -->

<!--   paste( -->

<!--     rep( -->

<!--     "üö¨", 8 -->

<!--   ), collapse = "") -->

<!--     ), -->

<!--   Propensity = c( -->

<!--     "2 / 10", -->

<!--     "8 / 10" -->

<!--   ), -->

<!--   IPW = c( -->

<!--     "10 / 2", -->

<!--     "10 / 8" -->

<!--   ) -->

<!--   ) |> -->

<!--   reactable( -->

<!--     columns = list( -->

<!--       Population = colDef( -->

<!--         maxWidth = 160 -->

<!--       ), -->

<!--       Propensity = colDef( -->

<!--         name = "P(A|L)", -->

<!--         maxWidth = 100 -->

<!--       ), -->

<!--       IPW = colDef( -->

<!--         name = "W<sup>A", -->

<!--         maxWidth = 100, -->

<!--         html = TRUE -->

<!--       ) -->

<!--       ), -->

<!--   columnGroups = list( -->

<!--     colGroup(name = "Original Sample", columns = c("Population", "Propensity")) -->

<!--   ) -->

<!--   ) -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="50%"} -->

<!-- ![](imbalanced_smoking_parents.svg) -->

<!-- ::: -->

<!-- ::: -->

<!-- ## Weights for Smoking Parents üò§ {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="50%"} -->

<!-- ```{r} -->

<!-- data.frame( -->

<!--   Population = c( -->

<!--     paste( -->

<!--     rep( -->

<!--     "üö≠", 10 -->

<!--   ), collapse = ""), -->

<!--   paste( -->

<!--     rep( -->

<!--     "üö¨", 10 -->

<!--   ), collapse = "") -->

<!--     ), -->

<!--   Propensity = c( -->

<!--     "10 / 20", -->

<!--     "10 / 20" -->

<!--   ) -->

<!--   ) |> -->

<!--   reactable( -->

<!--     columns = list( -->

<!--       Population = colDef( -->

<!--         maxWidth = 160 -->

<!--       ), -->

<!--       Propensity = colDef( -->

<!--         name = "P(A|L)", -->

<!--         maxWidth = 100 -->

<!--       ) -->

<!--       ), -->

<!--   columnGroups = list( -->

<!--     colGroup(name = "Weighted Sample", columns = c("Population", "Propensity")) -->

<!--   ) -->

<!--   ) -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="50%"} -->

<!-- ![](balanced_smoking_parents.svg) -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_with_weights <- countefactual_data |>  -->

<!--   select(X, A, observed_y) |> -->

<!--   mutate(W_a =  -->

<!--            case_when( -->

<!--              (X=="0" & A == "0") ~ 1.5, -->

<!--              (X=="0" & A == "1") ~ 3, -->

<!--              (X=="1" & A == "0") ~ 5, -->

<!--              (X=="1" & A == "1") ~1.25 -->

<!--            )) |>  -->

<!--   reactable( -->

<!--   columns = list( -->

<!--     W_a = colDef( -->

<!--       name = "W<sup>a", -->

<!--       html = TRUE -->

<!--     ), -->

<!--     observed_y = colDef( -->

<!--       name = "Y" -->

<!--     ) -->

<!--   ), -->

<!--   rowStyle = function(index) { -->

<!--     if ( -->

<!--       (countefactual_data[index, "observed_y"] == "1") && -->

<!--       (countefactual_data[index, "A"] == "0")) list(background = "rgba(0, 0, 0, 0.15)") else if ( -->

<!--         (countefactual_data[index, "observed_y"] == "0") && -->

<!--       (countefactual_data[index, "A"] == "0") -->

<!--       ) list(background = "rgba(0, 0, 0, 0.05)") -->

<!--   }, -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 45), -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE)  -->

<!-- real_data_with_weights -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### Calculate estimate for Causal ATE ‚öñÔ∏è -->

<!-- ##### Non-Smokers outcome proportion (Psuedo-population) -->

<!-- -   6.5 cases (half a person is not a problem in pseudo population) of lung out of 16. -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_with_weights <- countefactual_data |>  -->

<!--   select(X, A, observed_y) |> -->

<!--   mutate(W_a =  -->

<!--            case_when( -->

<!--              (X=="0" & A == "0") ~ 1.5, -->

<!--              (X=="0" & A == "1") ~ 3, -->

<!--              (X=="1" & A == "0") ~ 5, -->

<!--              (X=="1" & A == "1") ~1.25 -->

<!--            )) |>  -->

<!--   reactable( -->

<!--   columns = list( -->

<!--     W_a = colDef( -->

<!--       name = "W<sup>a", -->

<!--       html = TRUE -->

<!--     ), -->

<!--     observed_y = colDef( -->

<!--       name = "Y" -->

<!--     ) -->

<!--   ), -->

<!--   rowStyle = function(index) { -->

<!--     if ( -->

<!--       (countefactual_data[index, "observed_y"] == "1") && -->

<!--       (countefactual_data[index, "A"] == "1")) list(background = "rgba(0, 0, 0, 0.15)") else if ( -->

<!--         (countefactual_data[index, "observed_y"] == "0") && -->

<!--       (countefactual_data[index, "A"] == "1") -->

<!--       ) list(background = "rgba(0, 0, 0, 0.05)") -->

<!--   }, -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 45), -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE)  -->

<!-- real_data_with_weights -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### Calculate estimate for Causal ATE ‚öñÔ∏è -->

<!-- ##### Non-Smokers outcome proportion (Psuedo-population) -->

<!-- -   6.5 cases (half a person is not a problem in pseudo population) of lung out of 16. -->

<!-- ##### Smokers Outcome Proporiton (Psuedo-population) -->

<!-- -   10.5 cases out of 16. -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_with_weights <- countefactual_data |>  -->

<!--   select(X, A, observed_y) |> -->

<!--   mutate(W_a =  -->

<!--            case_when( -->

<!--              (X=="0" & A == "0") ~ 1.5, -->

<!--              (X=="0" & A == "1") ~ 3, -->

<!--              (X=="1" & A == "0") ~ 5, -->

<!--              (X=="1" & A == "1") ~1.25 -->

<!--            )) |>  -->

<!--   reactable( -->

<!--   columns = list( -->

<!--     W_a = colDef( -->

<!--       name = "W<sup>a", -->

<!--       html = TRUE -->

<!--     ), -->

<!--     observed_y = colDef( -->

<!--       name = "Y" -->

<!--     ) -->

<!--   ), -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   defaultColDef = colDef(maxWidth = 45), -->

<!--   style = list(fontSize = "1rem"),  -->

<!--   fullWidth = FALSE)  -->

<!-- real_data_with_weights -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### Calculate estimate for Causal ATE ‚öñÔ∏è -->

<!-- ##### Non-Smokers outcome proportion (Psuedo-population) -->

<!-- -   6.5 cases (half a person is not a problem in pseudo population) of lung out of 16. -->

<!-- ##### Smokers Outcome Proporiton (Psuedo-population) -->

<!-- -   10.5 cases out of 16. -->

<!-- ##### Estimate of Causal Average Treatment Effect -->

<!-- $\hat{ATE} = \frac{10.5}{16} - \frac{6.5}{16} = 0.25$ -->

<!-- ::: -->

<!-- ::: -->

<!-- # Second Solution: Standardization üóÉ -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- real_data_reactable_raw -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### Standardization üóÉ -->

<!-- -   The marginal counterfactual risk $Pr[Y^{a=1}]$ is the weighted average of the stratum-specific risks $Pr[Y^{a=1}|X =0]$ and $Pr[Y^{a=1}|X =1]$, in other words: -->

<!-- $Pr[Y^{a=1}] = \sum_{X=x}Pr[Y^{a=1}|X =x]*Pr(X=x)$ -->

<!-- -   Under conditional exchangeability: -->

<!-- $\hat{Pr[Y^{a=1}]} = \sum_{X=x}Pr[Y=1|X =x, A=1]*Pr(X=x)$ -->

<!-- -   Therefore we can estimate directly the estimate for the average treatment effect if we will use estimates for every stratum of the confounders (X) and the Treatment (A). -->

<!-- -   The same goes for: -->

<!-- $\hat{Pr[Y^{a=0}]} = \sum_{X=x}Pr[Y=1|X =x, A=0]*Pr(X=x)$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ##  {.smaller} -->

<!-- ::: columns -->

<!-- ::: {.column width="35%"} -->

<!-- ```{r} -->

<!-- countefactual_data |>  -->

<!--   arrange(X) |>  -->

<!--   reactable( -->

<!--   sortable = FALSE, -->

<!--   defaultPageSize = 19, -->

<!--   columns = list( -->

<!--     observed_y = colDef( -->

<!--       name = "Y", -->

<!--       style = function(value) { -->

<!--       if(value == "1") -->

<!--       list(background = "pink") -->

<!--     } -->

<!--     ), -->

<!--     A = colDef( -->

<!--       style = function(value) { -->

<!--       if (value == "1") -->

<!--       list(background = "#F2F3AE") -->

<!--       }  -->

<!--     ), -->

<!--     X = colDef( -->

<!--       style = function(value) { -->

<!--       if (value == "1") -->

<!--       list(background = "lightblue") -->

<!--       }  -->

<!--     ), -->

<!--     Y_a0 = colDef( -->

<!--       show = FALSE -->

<!--     ), -->

<!--     Y_a1 = colDef( -->

<!--       show = FALSE -->

<!--     ), -->

<!--     ITE = colDef( -->

<!--       show = FALSE -->

<!--     ) -->

<!--   ), -->

<!--   defaultColDef = colDef(maxWidth = 40), -->

<!--   style = list(fontSize = "1rem")) -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {.column width="65%"} -->

<!-- #### Standardization üóÉ -->

<!-- $\hat{Pr[Y^{a=1}]} = \frac{1}{2}*\frac{6}{16} + \frac{6}{8}*\frac{10}{16} = 0.625$ -->

<!-- $\hat{Pr[Y^{a=0}]} = \frac{1}{4}*\frac{6}{16} + \frac{1}{2}*\frac{10}{16} = 0.425$ -->

<!-- ##### Estimate of Causal Average Treatment Effect -->

<!-- $\hat{ATE} = \frac{10.5}{16} - \frac{6.5}{16} = 0.25$ -->

<!-- ::: -->

<!-- ::: -->

<!-- ## Parametric Versions -->

<!-- -   Parametric versions of IPW and Standardization will yield different estimates unlike the Non-Parametric Versions. -->

<!-- -   For IPW: We can use ML for propensity! ü§ñ -->

<!-- -   For Standardization: We can use ML ü§ñ (T/S/X Learners) or old-school outcome regressions üë¥ (just don't use colliders). -->

<!-- ## Benefits -->

<!-- -   **IPW**: Model for the treatment without overfitting the for the outcome. -->

<!-- -   **Standardization**: CATE / ITE. -->

<!-- -   **Doubly Robust**: Estimates are consistent even if we are wrong about treatment model or outcome model. -->

<!-- [Check out our paper!](https://pubmed.ncbi.nlm.nih.gov/35598055/) -->
